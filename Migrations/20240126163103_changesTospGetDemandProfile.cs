using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace ClientPortal.Migrations
{
    public partial class changesTospGetDemandProfile : Migration
    {
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.Sql("CREATE OR ALTER proc [dbo].[spGetDemandProfile]\r\n(\r\n@MeterId int,\r\n@SDate smalldatetime,\r\n@EDate smalldatetime,\r\n@TOUId int,\r\n@RegisterId int\r\n)\r\n\r\nAS\r\n\r\n--declare\r\n--@MeterId int = 701,\r\n--@SDate smalldatetime = '2024-01-01 00:30',\r\n--@EDate smalldatetime = '2024-01-08 00:00',\r\n--@TOUId int = 4,\r\n--@RegisterId int = 0\r\n\r\ndeclare\r\n@RowCnt int\r\n\r\ndeclare @tMeter table (Id int, Serial nvarchar(50))\r\ndeclare @tData table (Id int identity(1,1), ReadingDate smalldatetime, ShortName varchar(20), Demand decimal(18,4), ActEnergy decimal(18,4), ReActEnergy decimal(18,4), Calculated bit)\r\n\r\ninsert into @tMeter\r\nselect Id, MeterSerial from AMRMeters where Id = @MeterId\r\n\r\ninsert into @tData\r\nselect\r\nconvert(varchar(16), d.ReadingDate, 120) as ReadingDate,\r\nisnull(r.ShortName, '') as ShortName,\r\nDemand = d.kVA,\r\nActEnergy = d.P1/2,\r\nReActEnergy = d.Q1/2,\r\nCalculated = case when d.Status = 0 then 0 else 1 end\r\nfrom\r\n@tMeter m\r\njoin ScadaProfileData d (NOLOCK) on (m.Serial = d.SerialNumber and d.IsActive = 1)\r\njoin TOUSeasonMonths sm (NOLOCK) on (datepart(m, d.ReadingDate) = sm.MonthNo and sm.Active = 1)\r\njoin TOUSeasons s (NOLOCK) on (sm.TOUSeasonId = s.Id)-- and s.TOUHeaderId = @TOUId)\r\njoin TOUDayOfWeekDayTypes w (NOLOCK) on (datepart(dw, d.ReadingDate) = w.TOUDaysOfWeekId and w.TOUHeaderId = @TOUId)\r\njoin TOUHalfHours hh (NOLOCK) on (cast(d.ReadingDate as time(0)) > hh.Start and cast(d.ReadingDate as time(0)) <= hh.[End])\r\njoin TOUProfileAssignments pa (NOLOCK) on (s.Id = pa.TOUSeasonId and w.TOUDayTypeId = pa.TOUDayTypeId and hh.Id = pa.TOUHalfHourId and pa.Active = 1 and pa.TOUHeaderID = @TOUId)\r\nleft join TOURegisters r (NOLOCK) on (pa.TOURegisterId = r.Id and r.Active = 1 and (r.Id = @RegisterId or @RegisterId = 0))\r\nwhere\r\nm.Id = @MeterId\r\nand d.ReadingDate >= @SDate and d.ReadingDate <= @EDate\r\nand d.isActive = 1\r\norder by\r\nd.ReadingDate\r\n\r\nselect @RowCnt = count(1) from @tData where ShortName <> ''\r\n\r\nselect\r\nm.Id as MeterId,\r\nm.MeterNo as MeterNo,\r\nm.Description,\r\n@SDate as StartDate,\r\n@EDate as EndDate,\r\n(select MAX(Demand) from @tData where ShortName in ('Peak','Standard')) as MaxDemand,\r\n(select top 1 ReadingDate from @tData where ShortName in ('Peak','Standard') order by Demand desc) as MaxDemandDate,\r\nPeriodUsage = (select sum(ActEnergy)/2 from @tData),\r\n(@RowCnt/(DATEDIFF(HH, @SDate, @EDate)*2.00)) as DataPercentage\r\n, PeakUsage = (select sum(case when ShortName = 'Peak' then ActEnergy else 0 end)/2 from @tData)\r\n, StandardUsage = (select sum(case when ShortName = 'Standard' then ActEnergy else 0 end)/2 from @tData)\r\n, OffPeakUsage = (select sum(case when ShortName = 'Off-Peak' then ActEnergy else 0 end)/2 from @tData)\r\n, PeakDemand = (select MAX(Demand) from @tData where ShortName in ('Peak'))\r\n, StandardDemand = (select MAX(Demand) from @tData where ShortName in ('Standard'))\r\n, OffPeakDemand = (select MAX(Demand) from @tData where ShortName in ('Off-Peak'))\r\nfrom\r\nAMRMeters m\r\nwhere\r\nm.Id = @MeterId\r\n--for JSON auto\r\n\r\nselect ReadingDate, ShortName, Demand, ActEnergy*2 as ActEnergy, ReActEnergy*2 as ReActEnergy, Calculated\r\n,case when ShortName = 'Peak' then 'Red' when ShortName = 'Standard' then 'Yellow' else 'Green' end as Color\r\nfrom @tData");
        }

        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.Sql("CREATE OR ALTER proc [dbo].[spGetDemandProfileAlarms]\r\n(\r\n@MeterId int,\r\n@SDate smalldatetime,\r\n@EDate smalldatetime,\r\n@NightFlowStart time = '22:00',\r\n@NightFlowEnd time = '05:00',\r\n@ApplyNightFlow bit = 1\r\n)\r\nAS\r\n\r\n--declare\r\n--@MeterId int = 687,\r\n--@SDate smalldatetime = '2023-10-01 00:30',\r\n--@EDate smalldatetime = '2023-10-08 00:00',\r\n--@NightFlowStart time = '22:00',\r\n--@NightFlowEnd time = '05:00',\r\n--@ApplyNightFlow bit = 0\r\n\r\ndeclare\r\n@RowCnt int\r\n\r\ndeclare @tMeter table (Id int, Serial nvarchar(50))\r\ndeclare @tData table (Id int identity(1,1), ReadingDate smalldatetime, Energy decimal(18,4), Demand decimal(18,4), Calculated bit)\r\n\r\ninsert into @tMeter\r\nselect Id, MeterSerial from AMRMeters where Id = @MeterId\r\n\r\ninsert into @tData\r\nselect\r\nconvert(varchar(16), d.ReadingDate, 120) as ReadingDate,\r\nEnergy = d.P1/2,\r\nDemand = d.kVA,\r\nCalculated = case when d.Status = 0 then 0 else 1 end\r\n--, *\r\nfrom\r\n@tMeter m\r\njoin ScadaProfileData d (NOLOCK) on (m.Serial = d.SerialNumber and d.IsActive = 1)\r\nwhere\r\nm.Id = @MeterId\r\nand d.ReadingDate >= @SDate and d.ReadingDate <= @EDate\r\nand d.isActive = 1\r\norder by\r\nd.ReadingDate\r\n\r\nselect @RowCnt = count(1) from @tData\r\n\r\nselect\r\nm.Id as MeterId,\r\nm.MeterNo as MeterNo,\r\nm.Description,\r\n@SDate as StartDate,\r\n@EDate as EndDate,\r\n(select MAX(Demand) from @tData ) as MaxDemand,\r\n(select top 1 ReadingDate from @tData order by Energy desc) as MaxDemandDate,\r\n(select sum(Energy) from @tData where \r\n    ( cast(ReadingDate as time(0)) >= @NightFlowStart and cast(ReadingDate as time(0)) < cast('1900-01-01 00:00' as time(0)) ) or \r\n    ( cast(ReadingDate as time(0)) >= cast('1900-01-01 00:00' as time(0)) and cast(ReadingDate as time(0)) < @NightFlowEnd )\r\n    ) as NightFlow,\r\nPeriodUsage = (select sum(Energy)/2 from @tData),\r\n(@RowCnt/(DATEDIFF(HH, @SDate, @EDate)*2.00)) as DataPercentage\r\nfrom\r\nAMRMeters m\r\nwhere\r\nm.Id = @MeterId\r\n--for JSON auto\r\n\r\nselect ReadingDate, Energy as Energy, Calculated\r\n,case when @ApplyNightFlow = 1 and (\r\n    ( cast(ReadingDate as time(0)) >= @NightFlowStart and cast(ReadingDate as time(0)) < cast('1900-01-01 23:59' as time(0)) ) or \r\n    ( cast(ReadingDate as time(0)) >= cast('1900-01-01 00:00' as time(0)) and cast(ReadingDate as time(0)) < @NightFlowEnd )) then '#4949d0'\r\nelse '#00cc00' end as Color\r\nfrom @tData");
        }
    }
}
